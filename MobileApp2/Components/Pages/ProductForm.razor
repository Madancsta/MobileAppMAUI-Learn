@* @page "/editProduct"
@using MobileApp2.Model
@inject NavigationManager NavigationManager

<h3>Add Product</h3>

<EditForm Model="product" OnValidSubmit="HandleValidSubmit">
    <DataAnnotationsValidator />

    <div class="mb-3">
        <label class="form-label">Name</label>
        <InputText @bind-Value="product.Name" class="form-control" />
        <ValidationMessage For="@(() => product.Name)" />
    </div>

    <div class="mb-3">
        <label class="form-label">Price</label>
        <InputNumber @bind-Value="product.Price" class="form-control" />
        <ValidationMessage For="@(() => product.Price)" />
    </div>

    <div class="mb-3">
        <label class="form-label">Description</label>
        <InputTextArea @bind-Value="product.Description" class="form-control" />
        <ValidationMessage For="@(() => product.Description)" />
    </div>

    <div class="mb-3">
        <label class="form-label">Image</label>
        <InputFile OnChange="HandleImageUpload" />
    </div>

    @if (!string.IsNullOrEmpty(product.Image))
    {
        <img src="@product.Image" width="150" class="mb-3" />
    }

    <button type="submit" class="btn btn-primary">Save</button>
</EditForm>

@code {
    private Product product = new();

    private void HandleValidSubmit()
    {
        product.Id = ProductStore.Products.Count + 1;
        ProductStore.Products.Add(product);

        NavigationManager.NavigateTo("/products");
    }
    private async Task HandleImageUpload(InputFileChangeEventArgs e)
    {
        var file = e.File;

        if (file == null)
            return;

        using var stream = file.OpenReadStream(maxAllowedSize: 5 * 1024 * 1024);
        var buffer = new byte[file.Size];
        await stream.ReadAsync(buffer);

        product.Image = $"data:{file.ContentType};base64,{Convert.ToBase64String(buffer)}";
    }
} *@
@page "/product"
@page "/product/{Id:int}"

@inject IProductService ProductService
@inject NavigationManager NavigationManager
@inject IJSRuntime JS
@using MobileApp2.Model

<h3>@(isEdit ? "Edit Product" : "Add Product")</h3>

<EditForm Model="product" OnValidSubmit="SaveProduct">
    <DataAnnotationsValidator />

    <InputText @bind-Value="product.Name" class="form-control mb-2" />
    <InputNumber @bind-Value="product.Price" class="form-control mb-2" />

    <!-- QUILL EDITOR -->
    <div class="mb-3">
        <label>Description</label>
        <div id="editor" style="height:200px; background:white;"></div>
    </div>

    <InputFile OnChange="HandleImageUpload" />

    <button class="btn btn-primary mt-2">Save</button>
</EditForm>

@code {
    [Parameter] public int? Id { get; set; }

    private Product product = new();
    private bool isEdit => Id.HasValue;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JS.InvokeVoidAsync(
                "initQuill",
                "editor",
                product.Description
            );
        }
    }

    private async Task SaveProduct()
    {
        // 🔥 Get HTML from Quill
        product.Description = await JS.InvokeAsync<string>("getQuillHtml");

        if (isEdit)
            ProductService.UpdateProduct(product);
        else
            ProductService.AddProduct(product);

        NavigationManager.NavigateTo("/products");
    }

    protected override void OnInitialized()
    {
        if (isEdit)
        {
            product = ProductService.GetProductById(Id.Value);
        }
    }

    private async Task HandleImageUpload(InputFileChangeEventArgs e)
    {
        var file = e.File;
        using var stream = file.OpenReadStream(5 * 1024 * 1024);
        var buffer = new byte[file.Size];
        await stream.ReadAsync(buffer);
        product.Image = $"data:{file.ContentType};base64,{Convert.ToBase64String(buffer)}";
    }
}


